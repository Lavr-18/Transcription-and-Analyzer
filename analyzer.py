import os
import json
import re
import time
from openai import OpenAI
from dotenv import load_dotenv
from datetime import datetime
from pathlib import Path
# Импортируем функцию для получения имени менеджера из CRM
# Убедитесь, что retailcrm_integration.py находится в той же директории или в PYTHONPATH
try:
    from retailcrm_integration import get_manager_name_from_crm
except ImportError:
    print("ВНИМАНИЕ: Модуль retailcrm_integration не найден или get_manager_name_from_crm не определена. Убедитесь, что он существует и доступен.")
    # Если модуль не найден, определяем заглушку, чтобы код продолжал работать.

    def get_manager_name_from_crm(phone_number: str) -> str:
        print("  ⚠️ Заглушка: retailcrm_integration.get_manager_name_from_crm не реализована. Возвращаем 'Неизвестно'.")
        return "Неизвестно"


load_dotenv()
openai_api_key = os.getenv("OPENAI_API_KEY")
client = OpenAI(api_key=openai_api_key)

CRITERIA = [
    "улыбка_в_голосе",
    "установление_контакта",
    "квалификация",
    "выявление_потребности",
    "пересогласование",
    "особенности_позиций",
    "возражение",
    "отработка_возражения",
    "докомплект",
    "допродажа",
    "состав_и_сумма",
    "согласование_деталей",
    "предоплата"
]

# Список всех возможных имен менеджеров, используемый для валидации
ALLOWED_MANAGERS = [
    "Анастасия",
    "Вера",
    "Амалия",
    "Евгения",
    "Антон",
    "Ангелина",
    "Виктория",
    "Александр",
    "Екатерина"
]

# Новые категории звонков
CALL_CATEGORIES = [
    "Заказ",  # Целевой звонок по продажам/консультации по продуктам
    "Курьер/Технический",  # Звонки, связанные с доставкой, техническими проблемами
    "Сотрудничество",  # Звонки по вопросам партнерства, рекламы, поставки
    "Неизвестно"  # Если категория не может быть однозначно определена
]

# Обновленный PROMPT_TEMPLATE: теперь это обычная строка, которая будет форматироваться
# с помощью .format() для вставки CALL_CATEGORIES, ALLOWED_MANAGERS и transcript.
# Все фигурные скобки, которые являются частью буквального текста (например, в JSON-примере),
# остаются одинарными.
PROMPT_TEMPLATE = '''Ты эксперт по продажам, анализирующий телефонные звонки. Твоя задача — внимательно проанализировать диалог между Менеджером и Клиентом и выставить ТОЧНУЮ оценку по каждому из 13 критериев из чек-листа ОКК. Если менеджер не задал какой-то вопрос, нужно указать это в SUMMARY

**Категоризация звонка:**
Определи категорию данного звонка из следующего списка: {}.
В JSON-ответе добавь новое поле "call_category" со значением из этого списка.
Если "call_category" равно "Курьер/Технический" или "Сотрудничество" или "Неизвестно", то все остальные критерии ("улыбка_в_голосе", "установление_контакта" и т.д., кроме "manager_name") должны быть равны 0 (не применимо).

**Интерпретация оценок (СТРОГО используй только эти значения):**
* **1 (выполнено):** Критерий выполнен полностью, эффективно и согласно всем требованиям.
* **0 (не применимо):** Критерий не применим к данному конкретному диалогу, так как не было соответствующей ситуации или возможности для его выполнения.
* **-1 (не выполнено):** Критерий был необходим, но менеджер его не выполнил, выполнил плохо, проигнорировал или допустил ошибку.

**Критерии для анализа (с детальной логикой оценки):**

1.  **Улыбка в голосе, энергичный тон:**
    * **1 (Выполнено):** Интонация менеджера позитивная, голос энергичный, звучит заинтересованно и доброжелательно на протяжении всего разговора.
    * **0 (Не применимо):** Недостаточно данных для оценки (например, очень короткий или чисто технический звонок).
    * **-1 (Не выполнено):** Голос монотонный, безразличный, уставший, грубый или излишне формальный. Отсутствие эмоциональной вовлеченности.

2.  **Установление контакта:**
    * **1 (Выполнено):** Менеджер активно стремится установить контакт, используя как минимум ДВА из следующих пунктов: 1) Улыбка в голосе, энергичный тон разговора, 2) Называть клиента по имени (если это уместно и доступно), 3) Комплименты (профессионализму клиента, настроению), 4) Подтверждение правильности выбора (например, "Рады вас слышать!", "Вы сделали правильный выбор, обратившись к нам!").
    * **0 (Не применимо)::** Короткий звонок или контекст не предполагал такого взаимодействия.
    * **-1 (Не выполнено):** Менеджер сразу переходит к делу без приветствия, не использует имя клиента, не представляется, или приветствие было сухим/формальным, не используя никаких пунктов для установления контакта. 

3.  **Квалификация (что нужно, когда, сроки, бюджет):**
    * **1 (Выполнено)::** Менеджер задал ВСЕ ТРИ ключевых вопроса на квалификацию:  1) Что именно интересует?, 2) К какой дате подбираете? 3) Есть ли рамки по бюджету?, чтобы собрать исчерпывающую информацию для предложения наилучшего решения.
    * **0 (Не применимо)::** Клиент сам четко и полно озвучил все детали запроса без необходимости уточнения по всем трем пунктам.
    * **-1 (Не выполнено)::** Менеджер задал менее трех вопросов на квалификацию, вопросы неточные, неполные, или сразу перешел к предложению без достаточного понимания ситуации клиента.

4.  **Выявление потребности — какую проблему решает клиент:**
    * **1 (Выполнено):** Менеджер задал БОЛЕЕ ТРЕХ вопросов из списка для глубокого выявления потребностей и мотиваций клиента. Список вопросов: 1) Какой размер смотрите?, 2) Куда выбираете?, 3) Что для вас важно при выборе растения? (Цена, сроки, другие параметры....), 4) Почему именно "такой вариант" хотите?, 5) Первый раз покупаете растение?,  6) Уже знаете как правильно ухаживать за растением?, 7) Вам нужно менее прихотливое растение или это не важно?.
    * **0 (Не применимо)::** Клиент с самого начала четко сформулировал свою проблему и цель покупки, не оставляя места для дальнейшего выявления, или звонок не предполагал глубокого выявления.
    * **-1 (Не выполнено)::** Менеджер задал менее трех вопросов на выявление, или не пытался понять глубинные потребности клиента, ориентировался только на поверхностный запрос, игнорировал сигналы клиента о проблемах.

5.  **Пересогласование на основе выявленных потребностей:**
    * **1 (Выполнено):** Менеджер, исходя из всех выявленных потребностей и проблем клиента, САМОСТОЯТЕЛЬНО предлагает КОНКРЕТНОЕ решение или несколько вариантов. При этом презентация решения проводится с применением как минимум ОДНОГО блока презентации (из примеров: преимущества компании, преимущества продукта), привязанного к 2-3 выявленным потребностям или запросам клиента. Также может быть использована как минимум ОДНА история/кейс для усиления ценности.
    * **0 (Не применимо)::** Клиент точно знал, что ему нужно, и не было выявленных потребностей, требующих презентации решения или пересогласования.
    * **-1 (Не выполнено)::** Предложенное решение не соответствует выявленным потребностям, или менеджер не смог сформировать предложение на основе собранной информации, или не использовал блоки презентации/истории, привязанные к потребностям клиента.

6.  **Проговорить особенности позиций:**
    * **1 (Выполнено)::** Менеджер ПРОАКТИВНО и ПОЛНОСТЬЮ рассказывает о специфических свойствах, сложностях ухода, уникальности, условиях выращивания или ограничениях предлагаемых товаров (например, "Этот сорт требует много света и не переносит сквозняков", "Это эксклюзивное растение, доступно в ограниченном количестве", "Нужен особый грунт").
    * **0 (Не применимо)::** Не было позиций с особенностями, требующими дополнительного описания, или клиент уже был полностью осведомлен.
    * **-1 (Не выполнено)::** Менеджер не упомянул важные особенности товара, которые могли бы повлиять на решение или ожидания клиента, или информация была неполной/неясной.

7.  **Возражение клиента — фраза:**
    * **1 (Выполнено):** Клиент четко сформулировал возражение, сомнение, отказ или встречное условие (например, "Это дорого", "Я подумаю", "У меня уже такое было, оно засохло", "Мне не нравится цвет"). Присутствует фраза, подтверждающая наличие возражения.
    * **0 (Не применимо)::** Возражений со стороны клиента не было.
    * **-1 (Не выполнено)::** Возражение клиента было, но менеджер его полностью проигнорировал, не дал клиенту высказаться или перебил его, не зафиксировав возражение.

8.  **Отработка возражения:** (Этот критерий актуален, только если было возражение)
    * **1 (Выполнено)::** Менеджер активно и эффективно работает с возражением, применив формулу работы с возражениями (как минимум ДВЕ ПОПЫТКИ отработки, каждая включает: 1) Уточняющий вопрос, 2) Аргумент, 3) Закрывающий вопрос). По итогу диалога возражение снято или удалось продвинуться дальше по сделке.
    * **0 (Не применимо)::** Возражений не было или они были незначительными, не требующими специальной отработки.
    * **-1 (Не выполнено)::** Штрафуется, только если есть пункт 1 в "Возражение клиента". Менеджер не отработал возражение, отработал его неэффективно (аргументы неубедительны, менеджер спорит с клиентом, не предлагает решения), усугубил возражение или попытка отработки не соответствовала формуле работы с возражениями.
    Если менеджер не отработал возражение должным образом, то нужно указать в SUMMARY в чем именно была ошибка.

9.  **Предложить докомплект:**
    * **1 (Выполнено)::** Менеджер предложил сопутствующие товары (докомплект), логически дополняющие основную покупку (например, кашпо, грунт, пересадка, дренаж), и применил формулу оффера доппродажи: 1) Упомянул, что другие клиенты покупают это дополнительно, 2) Объяснил, почему это нужно/интересно/полезно/выгодно клиенту, 3) Сделал закрытие на покупку (с 2 вариантами выбора).
    * **0 (Не применимо)::** Контекст звонка не предполагал докомплекта (например, клиент уже купил всё необходимое или звонок не дошел до этапа формирования заказа).
    * **-1 (Не выполнено)::** Менеджер упустил возможность предложить докомплект, хотя она была очевидна и уместна, или предложение не соответствовало формуле доппродажи.
    Если менеджер не предложил докомлект должным образом, то нужно указать в SUMMARY в чем именно была ошибка.

10. **Предложить допродажу:**
    * **1 (Выполнено)::** Менеджер предложил дополнительные товары или услуги (допродажу), увеличивающие средний чек, но не являющиеся прямым дополнением к основному товару (например, другие растения, удобрения, освещение, аксессуары, сервисное обслуживание), и применил формулу оффера доппродажи: 1) Упомянул, что другие клиенты покупают это дополнительно, 2) Объяснил, почему это нужно/интересно/полезно/выгодно клиенту, 3) Сделал закрытие на покупку (с 2 вариантами выбора).
    * **0 (Не применимо)::** Контекст звонка не предполагал допродажи, или основная покупка уже была максимальной, или клиент четко дал понять, что ничего больше не нужно.
    * **-1 (Не выполнено)::** Менеджер не предложил допродажу, хотя такая возможность была очевидна и могла увеличить ценность для клиента, или предложение не соответствовало формуле доппродажи.
    Если менеджер не предложил допродажу должным образом, то нужно указать в SUMMARY в чем именно была ошибка.

11. **Проговорить состав заказа и общую сумму:**
    * **1 (Выполнено)::** Менеджер ЧЕТКО, ПОЛНОСТЬЮ и ОДНОЗНАЧНО озвучивает перечень всех выбранных товаров и ИТОГОВУЮ СУММУ заказа. (Пример: "Итак, в вашем заказе: [позиция1] за [сумма1], [позиция2] за [сумма2], итого к оплате [общая сумма] рублей").
    * **0 (Не применимо)::** Звонок не дошел до этапа формирования заказа.
    * **-1 (Не выполнено)::** Менеджер не озвучил состав заказа, или сумму, или сделал это нечетко/неполно, создав путаницу.

12. **Согласовать детали (адрес; сроки доставки):**
    * **1 (Выполнено)::** Менеджер проактивно подтверждает или уточняет КЛЮЧЕВЫЕ детали завершения сделки: точный адрес доставки (или условия самовывоза), желаемые/возможные сроки доставки/получения, контактные данные, способ связи. Обязательно использована фраза фиксации договоренностей с 2 вариантами на выбор (например, "Тогда договариваемся, что приедете к нам сегодня в 16.00...", "Отлично, придержу за вами растения, к концу дня буду ждать оплату...").
    * **0 (Не применимо)::** Звонок завершился до этапа согласования деталей (например, клиент отказался или прервал звонок до этого этапа).
    * **-1 (Не выполнено)::** Менеджер не уточнил или упустил важные детали, необходимые для организации доставки/получения заказа, или эти детали были согласованы неясно, или не зафиксировал договоренности.

13. **Проговорить про предоплату по схеме: дедлайн + причина:**
    * **1 (Выполнено)::** Менеджер четко объясняет УСЛОВИЯ предоплаты: устанавливает конкретный дедлайн (например, "оплатите в течение часа", "сегодня до конца рабочего дня") и ОБЯЗАТЕЛЬНО ОБЪЯСНЯЕТ причину (например, "это необходимо для бронирования растения, так как бирочки вешаем только после предоплаты", "для подтверждения заказа и передачи его в сборку"). Может быть использован дедлайн-бонус для стимулирования оплаты.
    * **0 (Не применимо)::** Условия сделки не предусматривали предоплаты.
    * **-1 (Не выполнено)::** Менеджер не проговорил про предоплату, проговорил нечетко, без дедлайна или без объяснения причины, не смог ответить на вопросы по предоплате, или упустил возможность применения дедлайн-бонуса при его уместности.

Также, если Менеджер представился, укажи его имя отдельным полем "manager_name" в конце JSON-ответа. **Используй только имена из предоставленного списка. Это очень важно для корректной аналитики. Имя должно быть строго из списка. Если имя не найдено, укажи "Неизвестно".**
Не путай, когда представился менеджер, а когда он назвал имя клиента.

**Вот список всех возможных имен менеджеров, используй их точно как указано:**
{}

**Формат ответа:**
Строго JSON формат для оценок критериев, имени менеджера и категории звонка. После JSON блока должна быть строка `---SUMMARY---`, а затем краткое резюме звонка с ключевыми выводами для РОПа.

**Инструкции для резюме (summary):**
Резюме должно быть структурированным и содержать ключевые выводы для РОПа, отвечая на следующие вопросы. Используй HTML-тег `<b>` для выделения заголовков жирным шрифтом и разделяй каждый пункт пустой строкой, чтобы улучшить читаемость.
* <b>Исход звонка:</b> Чем закончился разговор (заказ, отказ, перенос, запрос информации и т.д.).
* <b>Квалификация:</b> Какие вопросы менеджер задал по квалификации (например, по бюджету, срокам) или почему не задал.
* <b>Выявление потребностей:</b> Какие вопросы менеджер задал для выявления потребностей клиента или почему не задал.
* <b>Презентация:</b> Как менеджер презентовал решение, что именно рассказал о продукте/компании.
* <b>Пересогласование:</b> Пытался ли менеджер пересогласовать решение на основе выявленных потребностей, и с каким результатом.
* <b>Возражения клиента:</b> Если были, пропиши текстом, что сказал клиент.
* <b>Отработка возражений:</b> Если были возражения, что говорил менеджер при их отработке.
* <b>Результат отработки возражений:</b> Клиент согласился или отказался после отработки возражения.
* <b>Дополнительные продажи (докомплект/допродажа):</b> Были ли предложены докомплект/допродажа, и если нет, то почему упущена возможность.
* <b>Договоренности:</b> Какие договоренности менеджер установил с клиентом (например, о доставке, оплате).
* <b>Следующий шаг:</b> Какие следующие шаги были обозначены менеджером или почему не были обозначены.
* <b>Общие рекомендации:</b> Что можно улучшить в работе менеджера (конкретные рекомендации по развитию навыков или подходов).

Пример JSON:
{{
  "call_category": "Заказ",
  "улыбка_в_голосе": 1,
  "установление_контакта": 1,
  "квалификация": 0,
  "выявление_потребности": 1,
  "пересогласование": 1,
  "особенности_позиций": 0,
  "возражение": 1,
  "отработка_возражения": 1,
  "докомплект": 0,
  "допродажа": 0,
  "состав_и_сумма": 1,
  "согласование_деталей": 1,
  "предоплата": 1,
  "manager_name": "Ольга"
}}
---SUMMARY---
* <b>Исход звонка:</b> Разговор завершился оформлением заказа и согласованием условий доставки и предоплаты.

* <b>Квалификация:</b> Менеджер не задал вопросы по бюджету и срокам.

* <b>Выявление потребностей:</b> Менеджер не задал вопросов для выявления потребностей клиента.

* <b>Презентация:</b> Менеджер кратко рассказал о характеристиках товара, но не привязал их к потребностям клиента.

* <b>Пересогласование:</b> Менеджер не пытался пересогласовать решение.

* <b>Возражения клиента:</b> Клиент сказал: "Это слишком дорого".

* <b>Отработка возражений:</b> Менеджер предложил рассмотреть более бюджетные варианты.

* <b>Результат отработки возражений:</b> Клиент согласился рассмотреть предложенные варианты.

* <b>Дополнительные продажи (докомплект/допродажа):</b> Возможность допродажи была упущена, так как менеджер не предложил сопутствующие товары.

* <b>Договоренности:</b> Установлены договоренности о доставке на следующий день и предоплате.

* <b>Следующий шаг:</b> Менеджер обозначил следующий шаг - ожидание предоплаты и отправка реквизитов.

* <b>Общие рекомендации:</b> Рекомендуется улучшить навыки установления контакта, задавать больше вопросов для понимания потребностей клиента и предлагать дополнительные товары для увеличения среднего чека.
Текст звонка для анализа:
"""
{transcript}
"""
'''


def clean_json_string(raw_content):
    """
    Извлекает JSON-строку из ответа модели, находя первый '{' и последний '}'.
    """
    first_brace = raw_content.find('{')
    last_brace = raw_content.rfind('}')

    if first_brace != -1 and last_brace != -1 and last_brace > first_brace:
        return raw_content[first_brace: last_brace + 1]
    return '{}'


def extract_summary(raw_content):
    """
    Извлекает резюме из ответа модели, которое находится после разделителя ---SUMMARY---.
    """
    # Ищем текст после последнего "---SUMMARY---"
    match = re.search(r'---SUMMARY---\s*([\s\S]*)', raw_content)
    return match.group(1).strip() if match else ''


# Функция categorize_call_by_metadata оставлена без изменений, так как она не влияет на логику анализа LLM/CRM
def categorize_call_by_metadata(raw_call_data: dict) -> str:
    """
    Категоризирует звонок на основе его метаданных (направления и длительности).
    """
    direction = raw_call_data.get("direction")
    duration = raw_call_data.get("duration")

    # Если звонок очень короткий (менее 10 секунд) и исходящий,
    # вероятно, это технический звонок или пропущенный
    if direction == "out" and duration is not None and duration < 10:
        return "Курьер/Технический"

    # Можно добавить более сложную логику категоризации здесь,
    # например, на основе определенных номеров или других полей.

    # По умолчанию, если нет явных признаков, считаем "Заказ"
    # или можно оставить "Неизвестно" и полагаться на LLM
    return "Заказ"  # Или "Неизвестно", если хотите, чтобы LLM определял это


def analyze_single_transcript(transcript_path: Path, target_folder_date_str: str, initial_category: str, phone_number: str | None = None):
    """
    Проводит анализ одного транскрипта и сохраняет результат в виде JSON-файла.

    Args:
        transcript_path (Path): Путь к файлу транскрипта.
        target_folder_date_str (str): Дата папки для сохранения анализов.
        initial_category (str): Начальная категория звонка (может быть переопределена LLM).
        phone_number (str | None): Номер телефона, извлеченный из имени файла, для CRM-запроса.
    """
    output_folder = Path("analyses") / f"транскрибация_{target_folder_date_str}"
    os.makedirs(output_folder, exist_ok=True)

    filename = transcript_path.name
    with open(transcript_path, "r", encoding="utf-8") as f:
        transcript = f.read()

    # Форматируем PROMPT_TEMPLATE, передавая все необходимые аргументы
    prompt = PROMPT_TEMPLATE.format(
        ", ".join(CALL_CATEGORIES),  # Для первого {} (список категорий)
        ", ".join(ALLOWED_MANAGERS),  # Для второго {} (список менеджеров)
        transcript=transcript  # Для {transcript}
    )

    success = False
    filtered_result = {key: 0 for key in CRITERIA}
    filtered_result["manager_name"] = "Неизвестно"
    filtered_result["summary"] = ""
    filtered_result["call_category"] = initial_category  # Используем начальную категорию

    for attempt in range(3):
        try:
            response = client.chat.completions.create(
                model="gpt-4o",
                messages=[{"role": "user", "content": prompt}],
                temperature=0,
            )
            raw_content = response.choices[0].message.content

            json_str = clean_json_string(raw_content)
            result_dict = json.loads(json_str)

            # Извлекаем категорию звонка из LLM, если LLM ее предоставил и она валидна
            call_category_from_llm = result_dict.get("call_category")
            if call_category_from_llm in CALL_CATEGORIES:
                filtered_result["call_category"] = call_category_from_llm
            else:
                # Если LLM не предоставил или предоставил невалидную, используем initial_category
                print(
                    f"⚠️ Предупреждение: Неизвестная категория звонка от LLM: {call_category_from_llm}. Используется начальная категория: {initial_category}.")
                filtered_result["call_category"] = initial_category

            analysis_summary = extract_summary(raw_content)
            if not analysis_summary:
                print(f"⚠️ Предупреждение: Резюме для {filename} пустое.")
                analysis_summary = "Резюме не сгенерировано."

            # Если категория не "Заказ", то устанавливаем все критерии (кроме manager_name и summary) в 0
            if filtered_result["call_category"] != "Заказ":
                for key in CRITERIA:
                    filtered_result[key] = 0
                print(
                    f"ℹ️ Звонок {filename} определен как '{filtered_result['call_category']}'. Критерии анализа продаж установлены в 0.")
            else:
                for key in CRITERIA:
                    # Убедимся, что значения 1, 0, -1
                    score = result_dict.get(key)
                    if score in [1, 0, -1]:
                        filtered_result[key] = score
                    else:
                        print(f"⚠️ Предупреждение: Некорректный балл {score} для критерия '{key}' в файле {filename}. Устанавливаем 0.")
                        filtered_result[key] = 0


            manager_name_from_llm = result_dict.get("manager_name")
            if manager_name_from_llm in ALLOWED_MANAGERS:
                filtered_result["manager_name"] = manager_name_from_llm
            else:
                filtered_result["manager_name"] = "Неизвестно"

            filtered_result["summary"] = analysis_summary

            success = True
            break
        except json.JSONDecodeError as e:
            print(f"⚠️ Ошибка JSON декодирования для {filename} (попытка {attempt + 1}): {e}")
            print(f"Сырой контент (начало): {raw_content[:500]}...")
            time.sleep(2)
        except Exception as e:
            print(f"⚠️ Непредвиденная ошибка при генерации/парсинге для {filename} (попытка {attempt + 1}): {e}")
            time.sleep(2)

    # --- Запасной вариант: Если имя менеджера не определено LLM, пытаемся получить его из CRM ---
    if filtered_result["manager_name"] == "Неизвестно" and phone_number:
        print(f"ℹ️ Имя менеджера не определено LLM. Пытаемся получить из CRM для номера: {phone_number}")
        crm_manager_name = get_manager_name_from_crm(phone_number)
        if crm_manager_name: # Если CRM вернула имя (не None)
            # Проверяем, что имя из CRM также находится в списке разрешенных менеджеров
            if crm_manager_name in ALLOWED_MANAGERS:
                filtered_result["manager_name"] = crm_manager_name
                print(f"✅ Имя менеджера успешно получено из CRM: {crm_manager_name}")
            else:
                print(f"⚠️ Имя менеджера '{crm_manager_name}' из CRM не найдено в списке разрешенных. Оставляем 'Неизвестно'.")
        else:
            print("ℹ️ Не удалось получить имя менеджера из CRM.")


    if not success:
        fail_path = output_folder / f"{filename.replace('.txt', '')}_raw.txt"
        with open(fail_path, "w", encoding="utf-8") as f:
            f.write(transcript)
        print(f"❌ Не удалось проанализировать: {filename} — исходный транскрипт сохранён как {fail_path}")

        # Если анализ не удался, но мы смогли получить менеджера из CRM, сохраняем его
        # Проверяем, что manager_name не был установлен CRM, прежде чем сбрасывать его
        if filtered_result["manager_name"] == "Неизвестно": # Только если CRM тоже не помогла
            filtered_result["manager_name"] = "Неизвестно"
        filtered_result["summary"] = "Ошибка анализа: не удалось сгенерировать корректные данные."
        filtered_result["call_category"] = "Неизвестно"  # Устанавливаем категорию по умолчанию
        for key in CRITERIA: # Сброс критериев, если LLM не сгенерировал корректный JSON
            # Не сбрасываем manager_name, так как он уже обработан выше
            filtered_result[key] = 0

    # Сохраняем анализ, только если это не "Курьер/Технический" звонок
    if filtered_result["call_category"] != "Курьер/Технический":
        out_path = output_folder / f"{transcript_path.stem}_analysis.json"
        with open(out_path, "w", encoding="utf-8") as f:
            json.dump(filtered_result, f, ensure_ascii=False, indent=2)
        print(f"✅ Анализ сохранён: {out_path}")
    else:
        print(f"⏩ Звонок {filename} определен как 'Курьер/Технический'. Анализ не сохранен.")


def analyze_transcripts(target_date_str: str):
    """
    Проводит анализ всех транскриптов в указанной папке
    и сохраняет результаты в виде JSON-файлов.

    Args:
        target_date_str (str): Дата, за которую нужно анализировать транскрипты, в формате "ДД.ММ.ГГГГ".
    """
    transcripts_folder = Path("transcripts") / f"транскрибация_{target_date_str}"
    audio_calls_folder = Path("audio") / f"звонки_{target_date_str}" # Добавляем путь к папке с аудио-информацией

    if not transcripts_folder.exists():
        print(f"Папка с транскриптами не найдена: {transcripts_folder}. Пропускаем анализ.")
        return

    print(f"Начинаем анализ транскриптов из папки: {transcripts_folder}")

    for filename in os.listdir(transcripts_folder):
        if filename.endswith(".txt") and not filename.endswith("_raw.txt"):
            transcript_path = transcripts_folder / filename
            base_name = filename.replace(".txt", "")

            # Извлекаем номер телефона из имени файла транскрипции
            # Пример имени файла: call123_79001234567.txt
            phone_number_match = re.search(r'call\d+_(\d+)', base_name)
            phone_number_from_filename = phone_number_match.group(1) if phone_number_match else None

            # Попытка загрузить call_info.json для получения raw данных и начальной категории
            initial_category = "Неизвестно"
            info_path = audio_calls_folder / f"{base_name}_call_info.json"
            if info_path.exists():
                try:
                    with open(info_path, "r", encoding="utf-8") as f:
                        call_info = json.load(f)
                        raw_call_data = call_info.get("raw", {})
                        initial_category = categorize_call_by_metadata(raw_call_data)
                except json.JSONDecodeError as e:
                    print(f"Ошибка декодирования JSON для {info_path}: {e}")
                except Exception as e:
                    print(f"Ошибка при чтении или обработке {info_path}: {e}")
            else:
                print(f"Предупреждение: Файл информации о звонке не найден для {base_name}: {info_path}. Используем категорию по умолчанию.")


            print(f"  Анализируем: {filename} (Начальная категория: {initial_category})")
            # Передаем извлеченный номер телефона в analyze_single_transcript
            analyze_single_transcript(transcript_path, target_date_str, initial_category, phone_number_from_filename)

    print(f"Анализ транскриптов для {target_date_str} завершен.")


if __name__ == "__main__":
    # Для тестирования модуля отдельно, используйте текущую дату
    today_str = datetime.today().strftime("%d.%m.%Y")
    analyze_transcripts(today_str)